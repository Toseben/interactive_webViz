<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<style type="text/css">
	        #progress {
				max-width: 250px;
				height: 100%;
				margin: 20% auto;
				display: block;
	        }
	    </style>
		<title>Bank Office Interior</title>
		<meta name="description" content="VR Interior Visualisation">
		<script src="https://aframe.io/releases/0.3.2/aframe.min.js"></script>
		<script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v2.7.2/dist/aframe-extras.min.js"></script>
		<script src="js/progressbar.js"></script>
	</head>
	<body>	

		<div id="progress"></div>

	<script>

		var bar = new ProgressBar.Circle(progress, {
			strokeWidth: 4,
			easing: 'easeInOut',
			duration: 0,
			color: '#FFEA82',
			trailColor: '#eee',
			trailWidth: 4,
			svgStyle: null,
			from: {color: '#FFEA82'},
			to: {color: '#ED6A5A'},
			step: (state, bar) => {
				bar.path.setAttribute('stroke', state.color);
				var value = Math.round(bar.value() * 100);
				if (value === 100) {
					setTimeout(function () {
						document.getElementById("progress").style.display = "none";
						}, 250);
				}
			}
		} );

		var addGeo, thisElement, loader, progressBar;
		var RESOURCES_LOADED = false;

		// Loading Manager //
		var manager = new THREE.LoadingManager();

		manager.onProgress = function (item, loaded, total) {
			progressBar = loaded / total;
			bar.animate(progressBar);
			if (item.split("/")[0] === 'geo'){
				thisElement.add(addGeo);
			};
		    //console.log(item, Math.floor(progressBar * 100) + '% loaded!');
		};

		manager.onLoad = function() {
			RESOURCES_LOADED = true;
 			console.log('Resources loaded!');
		};

		// Component
		AFRAME.registerComponent('objloader', {
			schema: {
				color: { default: "blue" },
				file: { default: "interiorBaked" }
			},

			init: function () {

				thisElement = this.el.object3D;
				var objName = this.data.file;

				// Loader //
				loader = new THREE.OBJLoader(manager);

				loader.load( "geo/" + objName + ".obj", function ( object ) {

					var material = new THREE.MeshBasicMaterial();
					loader = new THREE.TextureLoader(manager);

					object.traverse( function ( child ) {
						if (child instanceof THREE.Mesh) {
							child.material = material;
							child.material.map = loader.load( "img/" + objName + '_nonCompressed' + ".jpg" );
							addGeo = child;
						}	
					} );
			    } );

			}
		} );
	</script>

		<!-- Scene -->
		<a-scene physics="gravity: 0; debug: true" 
				 id='scene' >
			<!-- Camera -->
			<a-entity camera 
					  universal-controls 
					  kinematic-body 
					  position="0 1.8 0">
			  </a-entity>
			<!-- Geometry -->
			<a-entity objloader='file: ceilingBaked' 
					  position="0 0 0"
					  static-body="shape: auto"></a-entity>
			<a-entity objloader='file: interiorBaked' 
					  position="0 0 0"
					  static-body="shape: auto"></a-entity>
			<!-- Sky -->
		</a-scene>
	</body>
</html>